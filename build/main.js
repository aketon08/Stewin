class t{constructor(t,e){this.x=t,this.y=e??t}static add(e,s){return new t(e.x+s.x,e.y+s.y)}static multiply(e,s,i){return i?new t(e.x*i,e.y*i):s?new t(e.x*s.x,e.y*s.y):void 0}}class e{static cardinalDirections=[new t(0,1),new t(0,-1),new t(1,0),new t(-1,0)];static getRandomDirection(){return this.cardinalDirections[Math.ceil(4*Math.random()-1)]}}const s=(t,e,s,i)=>{const n=document.createElement(t);return e&&(n.id=e),s&&(n.className=s),i&&(n.innerText=i),n},i=t=>{document.getElementById(t).remove()},n=(t,e)=>{e.map((e=>document.getElementById(t).appendChild(e)))},a=t=>new Promise((e=>setTimeout(e,t)));let o;var h;(h=o||(o={}))[h.Empty=0]="Empty",h[h.FloorEmpty=1]="FloorEmpty",h[h.FloorFlower=2]="FloorFlower",h[h.FloorGrass=3]="FloorGrass",h[h.Sand=4]="Sand",h[h.Water=5]="Water";class r{constructor(t,e,s){this.position=t,this.direction=e,this.chanceToChange=s}}class m{floorConstraints=new t(.1,.25);constructor(t,e,s,i,n,a,o){this.mapDimensions=t,this.maxWalkers=s,this.fillPercentage=i,this.visualise=n,this.waitTime=a,this.ctx=e,this.generated=!1,this.game=o}initMap(){this.map=[],this.walkers=[],this.tileCount=0,this.generated=!1;for(let t=0;t<this.mapDimensions.x;t++){this.map[t]=[];for(let e=0;e<this.mapDimensions.y;e++)this.map[t][e]=o.Empty}this.walkers.push(new r(new t(Math.floor(this.mapDimensions.x/2),Math.floor(this.mapDimensions.y/2)),e.getRandomDirection(),.55));let s=this.walkers[0];this.createRandomFloorTile(s.position,this.floorConstraints),this.visualise&&this.draw(this.ctx),this.tick()}tick(){if(this.tileCount/(this.mapDimensions.x*this.mapDimensions.y)>=this.fillPercentage){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.generated=!0;for(let e=0;e<this.mapDimensions.x;e++)for(let s=0;s<this.mapDimensions.y;s++)this.map[e][s]=this.makeSand(new t(e,s))?o.Sand:this.map[e][s],this.map[e][s]=this.makeWater(this.map[e][s])?o.Water:this.map[e][s];return this.draw(this.ctx),void console.log("%cFinished generating map.   src: engine/walker.ts:89","color: #44ee66;font-size: 1.5em;font-family: 'Roboto Mono', monospace;")}for(let e of this.walkers)this.map[e.position.x][e.position.y]==o.Empty&&this.createRandomFloorTile(e.position,new t(.1,.25));this.chanceToRemove(),this.changeDirection(),this.chanceToCreate(),this.updatePosition(),this.visualise&&this.draw(this.ctx),a(this.waitTime).then((()=>this.tick()))}draw(e,s=new t(0,0)){e.clearRect(0,0,e.canvas.width,e.canvas.height);for(let e=0;e<this.mapDimensions.x;e++)for(let i=0;i<this.mapDimensions.y;i++){let n,a;this.generated?(n=new t(Math.floor(this.game.playerSize.x*e)+s.x,Math.floor(this.game.playerSize.y*i)+s.y),a=new t(this.game.playerSize.x+1,this.game.playerSize.y+1)):(n=new t(Math.floor(this.game.canvas.width/this.mapDimensions.x*e),Math.floor(this.game.canvas.height/this.mapDimensions.y*i)),a=new t(this.game.canvas.width/this.mapDimensions.x,this.game.canvas.height/this.mapDimensions.y));let h=this.map[e][i],r=!1;if([1,2,3].includes(h)&&(r=!0),!this.generated){if(r){this.game.draw(n,a,this.game.assets[1],new t(0,32),new t(32,32));continue}this.ctx.fillStyle="#000",this.ctx.fillRect(n.x,n.y,a.x+10,a.y+10)}n.x>-a.x&&n.x<this.game.canvas.width+a.x&&n.y>-a.y&&n.y<this.game.canvas.height+a.y&&this.generated&&(r?h==o.FloorEmpty?this.game.draw(n,a,this.game.assets[1],new t(0,32),new t(32,32)):h==o.FloorGrass?this.game.draw(n,a,this.game.assets[1],new t(0,0),new t(32,32)):h==o.FloorFlower&&this.game.draw(n,a,this.game.assets[1],new t(32,0),new t(32,32)):h!=o.Sand?(h==o.Water?this.ctx.fillStyle="#377":this.ctx.fillStyle="#000",this.game.draw(n,a)):this.game.draw(n,a,this.game.assets[1],new t(32,32),new t(32,32)))}}checkSurroundingTiles(t,e){for(let s=-1;s<2;s++)for(let i=-1;i<2;i++)if(null!=this.map[t+s]&&null!=this.map[t+s][e+i]&&[1,2,3].includes(this.map[t+s][e+i]))return!0}makeSand(t){if(this.map[t.x][t.y]==o.Empty&&this.checkSurroundingTiles(t.x,t.y))return!0}makeWater(t){if(t==o.Empty)return!0}createRandomFloorTile(t,e){let s=Math.random();s<e.x?this.map[t.x][t.y]=o.FloorFlower:s<e.y?this.map[t.x][t.y]=o.FloorGrass:this.map[t.x][t.y]=o.FloorEmpty,this.tileCount++}updatePosition(){for(let t=0;t<this.walkers.length;t++){let e=this.walkers[t];e.position.x+=e.direction.x,e.position.y+=e.direction.y,e.position.x=e.position.x>this.mapDimensions.x-1?0:e.position.x<0?this.mapDimensions.x-1:e.position.x,e.position.y=e.position.y>this.mapDimensions.y-1?0:e.position.y<0?this.mapDimensions.y-1:e.position.y}}changeDirection(){for(let t=0;t<this.walkers.length;t++){let s=this.walkers[t];Math.random()<s.chanceToChange&&(s.direction=e.getRandomDirection())}}chanceToCreate(){for(let s=0;s<this.walkers.length;s++){let i=this.walkers[s];if(Math.random()<i.chanceToChange&&this.walkers.length<this.maxWalkers){let s=new t(i.position.x,i.position.y),n=e.getRandomDirection();this.walkers.push(new r(s,n,i.chanceToChange))}}}chanceToRemove(){for(let t of this.walkers)Math.random()<t.chanceToChange&&this.walkers.length>1&&this.walkers.splice(this.walkers.indexOf(t),1)}}class c{constructor(t,e,s){this.requiredComponents=t,this.trigger=e,this.func=s}}class l{constructor(){this.entities=[],this.systemManager=new d}addEntity(t,e){this.entities.push(t),null!=e&&(t.components=e)}addSystem(t){this.systemManager.systems.push(t)}addTrigger(t){this.systemManager.triggers.includes(t)||this.systemManager.addTrigger(t)}update(t,e){this.systemManager.updateSystems(this.entities,t,e)}}class d{constructor(){this.systems=[],this.triggers=[]}addSystem(t){this.systems.push(t)}addTrigger(t){this.triggers.push(t)}removeTrigger(t){this.triggers.splice(this.triggers.indexOf(t),1)}updateSystems(t,e,s){for(let i=0;i<this.systems.length;i++){const n=this.systems[i];if(this.triggers.includes(n.trigger))for(let i=0;i<t.length;i++){const a=t[i];let o=0;for(let t=0;t<a.components.length;t++)for(let e=0;e<n.requiredComponents.length;e++)Object.getPrototypeOf(a.components[t]).constructor==n.requiredComponents[e]&&o++;o==n.requiredComponents.length&&n.func(a,e,s)}}}}class p{constructor(t){this.id=t,this.components=[]}getComponent(t){for(let e of this.components)if(e.name==t)return e}setComponent(t){for(let e=0;e<this.components.length;e++)this.components[e].name==t.name&&(this.components[e]=t)}}class g{constructor(t){this.name=t}}class w extends g{constructor(){super("move")}}class u extends g{constructor(t,e,s){super("image"),this.image=t,this.srcPos=e,this.srcDim=s}}class f extends g{constructor(t){super("position"),this.position=t}}class y extends g{constructor(t){super("dimensions"),this.dimensions=t}}class x extends c{constructor(){super([u,f,y],"render",((t,e)=>{const s=t.getComponent("image").image,i=t.getComponent("image").srcPos,n=t.getComponent("image").srcDim,a=t.getComponent("position").position,o=t.getComponent("dimensions").dimensions;e.drawImage(s,i.x,i.y,n.x,n.y,a.x,a.y,o.x,o.y)}))}}class v extends c{speed=2;foot=1;frame=new t(0,0);constructor(){super([w],"move",((e,s,i)=>{this.moveX=0,this.moveY=0;let n=Array(4).fill(!1);(M.w||M.ArrowUp)&&(n[0]=!0,M.a||M.ArrowLeft||M.d||M.ArrowRight?this.moveY+=Math.sin(45)*this.speed:this.moveY+=this.speed),(M.s||M.ArrowDown)&&(n[2]=!0,M.a||M.ArrowLeft||M.d||M.ArrowRight?this.moveY-=Math.sin(45)*this.speed:this.moveY-=this.speed),(M.a||M.ArrowLeft)&&(n[1]=!0,M.w||M.ArrowUp||M.s||M.ArrowDown?this.moveX+=Math.sin(45)*this.speed:this.moveX+=this.speed),(M.d||M.ArrowRight)&&(n[3]=!0,M.w||M.ArrowUp||M.s||M.ArrowDown?this.moveX-=Math.sin(45)*this.speed:this.moveX-=this.speed),i.mapOffset.x>=0&&(i.mapOffset.x=0,this.moveX=this.moveX>0?0:this.moveX),i.mapOffset.x<=-Math.floor(i.mapDimensions.x*i.playerSize.x-i.canvas.width)&&(i.mapOffset.x=-Math.floor(i.mapDimensions.x*i.playerSize.x-i.canvas.width),this.moveX=this.moveX<0?0:this.moveX),i.mapOffset.y>=0&&(i.mapOffset.y=0,this.moveY=this.moveY>0?0:this.moveY),i.mapOffset.y<=-Math.floor(i.mapDimensions.y*i.playerSize.y-i.canvas.height)&&(i.mapOffset.y=-Math.floor(i.mapDimensions.y*i.playerSize.y-i.canvas.height),this.moveY=this.moveY<0?0:this.moveY);for(let t=0;t<4;t++)n[t]&&n[(t+2)%4]&&(n[t]=!1,n[(t+2)%4]=!1),0==t?n[t]&&(n[t+1]||n[t+3])&&(n[t+1]=!1,n[t+3]=!1):2==t&&n[t]&&(n[t-1]||n[t+1])&&(n[t-1]=!1,n[t+1]=!1);let a=n.indexOf(!0);if(a=-1==a?2:a,n.every((t=>!1===t)))this.frame.x=0;else if(i.frames%12==0)switch(a){case 0:case 2:0==this.frame.x?this.frame.x=this.foot:(1==this.foot?this.foot=2:this.foot=1,this.frame.x=0);break;case 1:case 3:0==this.frame.x?this.frame.x=1:this.frame.x=0}this.frame.y=a,i.ecs.entities[0].setComponent(new u(i.assets[0],t.multiply(this.frame,null,32),new t(32))),i.mapOffset=t.add(i.mapOffset,new t(this.moveX,this.moveY))}))}}const M=[];let S;var k;document.addEventListener("keydown",(t=>{M[t.key]=!0})),document.addEventListener("keyup",(t=>{M[t.key]=!1})),(k=S||(S={}))[k.image=0]="image",k[k.audio=1]="audio";var D;let b;var C;D=JSON.parse('{"name":"the_adventures_of_stewin","author":"Maxwell Robati","version":"0.1.0","license":"MIT","source":"src/main.ts","targets":{"bundle":{"sourceMap":false,"optimize":true,"outputFormat":"commonjs","distDir":"build"}},"scripts":{"watch":"parcel watch","build":"parcel build --no-cache"},"dependencies":{"parcel":"latest"}}'),(C=b||(b={}))[C.Loading=0]="Loading",C[C.Running=1]="Running",C[C.Menu=2]="Menu",C[C.Info=3]="Info";class T{mapOffset=new t(0,0);frames=0;stop=!1;constructor(e,s){this.dimensions=e,this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=this.dimensions.x,this.canvas.height=this.dimensions.y,this.ctx.fillStyle="#fff",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.playerSize=new t(this.canvas.width/10),this.mapDimensions=new t(45),this.assets=s,this.state=b.Menu,this.loadingStatus="",this.ctx.imageSmoothingEnabled=!1}run(){this.frames=0,this.stop=!0,this.tick(),this.stop=!1,this.initECS().then((()=>this.generateMap()))}initECS(){return new Promise((e=>{this.ecs=new l,this.loadingStatus="Loading player",this.ecs.addEntity(new p(this.ecs.entities.length),[new u(this.assets[0],new t(0,64),new t(32,32)),new f(new t(this.canvas.width/2-this.playerSize.x/2,this.canvas.height/2-this.playerSize.y/2)),new y(this.playerSize),new w]),this.ecs.addSystem(new x),this.ecs.addSystem(new v),e("resolved")}))}generateMap(){return this.loadingStatus="Generating map",new Promise((e=>{if(null!=this.simpleMap&&!this.simpleMap.generated)return void console.warn("Map is already generating");this.simpleMap=new m(this.mapDimensions,this.ctx,100,.4,!1,0,this),this.simpleMap.initMap(),this.mapOffset=new t(this.canvas.width/2-this.playerSize.x*this.mapDimensions.x/2);let s=setInterval((()=>{this.simpleMap.generated&&(this.state=b.Running,this.ecs.addTrigger("render"),this.ecs.addTrigger("move"),clearInterval(s))}),100);e("resolved")}))}draw(t,e,s,i,n){null==s?this.ctx.fillRect(t.x,t.y,e.x,e.y):this.ctx.drawImage(s,i.x,i.y,n.x,n.y,t.x,t.y,e.x,e.y)}tick(){this.state==b.Running&&this.simpleMap.generated&&(this.frames++,this.simpleMap.draw(this.ctx,this.mapOffset),this.ecs.update(this.ctx,this)),this.state==b.Loading&&this.loading(),this.state==b.Menu&&this.menu(),this.state==b.Info&&this.info(),this.stop||a(1e3/60).then((()=>{this.tick()}))}loading(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.font="30px Roboto Mono",this.ctx.fillStyle="#cbb",this.ctx.fillText(`${this.loadingStatus}...`,25,50)}menu(){if(this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.globalAlpha=.55,this.draw(new t(0),this.dimensions,this.assets[2],new t(0),new t(256)),this.ctx.globalAlpha=1,null==document.querySelector("div")){const t=s("span","start","button","Start Game!"),e=s("span","info","button","Info");document.body.appendChild(s("div","menu","menu")),n("menu",[t,e]),document.getElementById("start").addEventListener("click",(()=>{this.state=b.Loading,i("menu"),this.run()})),document.getElementById("info").addEventListener("click",(()=>{this.state=b.Info,i("menu")}))}}info(){if(this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.globalAlpha=.55,this.draw(new t(0),this.dimensions,this.assets[2],new t(0),new t(256)),this.ctx.globalAlpha=1,null==document.querySelector("div")){const t=s("span","back","button","Back"),e=s("span","info","text","Info");e.innerHTML="This is a game about a guy who walks around and does stuff.<br><br>It's pretty great you should donate to my patreon <br><a>here</a>",document.body.appendChild(s("div","info","info")),n("info",[t,e]),document.getElementById("back").addEventListener("click",(()=>{this.state=b.Menu,i("info")}))}}}const R=new class{#t;constructor(t){this.#t=t}loadAsset(t){return new Promise(((e,s)=>{if(t.type===S.image){const i=new Image;i.src=t.path,i.onload=t=>e(i),i.onerror=s}else if(t.type===S.audio){const i=new Audio;i.src=t.path,i.oncanplaythrough=t=>e(i),i.onerror=s}}))}async loadAssets(){return await Promise.all(this.#t.map((t=>this.loadAsset(t))))}}([{type:S.image,path:"resources/images/StewieSpriteSheet.png"},{type:S.image,path:"resources/images/TileSheet.png"},{type:S.image,path:"resources/images/Placeholder.png"},{type:S.audio,path:"resources/audio/TitleLong.wav"}]);let E,A,F;(async()=>{console.log("%cVersion: "+D.version,"color: #cbb; font-size: 20px; font-family: Roboto Mono; font-weight: bold; text-shadow: 0 0 10px #cbb;"),E=await R.loadAssets(),A=new t(innerHeight/6*5),F=new T(A,E),F.tick()})(),window.addEventListener("click",(t=>{"A"==t.target.tagName&&window.open("https://www.youtube.com/watch?v=dQw4w9WgXcQ")}));