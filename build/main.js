class t{constructor(t,e){this.x=t,this.y=e??t}static add(e,s){return new t(e.x+s.x,e.y+s.y)}static multiply(e,s,i){return i?new t(e.x*i,e.y*i):s?new t(e.x*s.x,e.y*s.y):void 0}}class e{static cardinalDirections=[new t(0,1),new t(0,-1),new t(1,0),new t(-1,0)];static getRandomDirection(){return this.cardinalDirections[Math.ceil(4*Math.random()-1)]}}const s=(t,e,s,i)=>{const a=document.createElement(t);return e&&(a.id=e),s&&(a.className=s),i&&(a.innerText=i),a},i=t=>{document.getElementById(t).remove()},a=(t,e)=>{e.map((e=>document.getElementById(t).appendChild(e)))},n=t=>new Promise((e=>setTimeout(e,t)));let o;var h;let r;var l;(h=o||(o={}))[h.Empty=0]="Empty",h[h.Floor=1]="Floor",h[h.FloorEmpty=2]="FloorEmpty",h[h.FloorFlower=3]="FloorFlower",h[h.FloorGrass=4]="FloorGrass",h[h.Sand=5]="Sand",h[h.Water=6]="Water",(l=r||(r={}))[l.Freezing=0]="Freezing",l[l.Cold=1]="Cold",l[l.Temperate=2]="Temperate",l[l.Warm=3]="Warm";class m{constructor(t,e,s){this.position=t,this.direction=e,this.chanceToChange=s}}class c{floorConstraints=new t(.1,.25);constructor(t,e,s,i,a,n,o,h=o.playerSize){this.mapDimensions=t,this.maxWalkers=s,this.fillPercentage=i,this.visualise=a,this.waitTime=n,this.ctx=e,this.generated=!1,this.game=o,this.tileSize=h}initBiomeMap(){}initMap(){this.game.loadingStatus="Generating map (1/5) - Walking",this.map=[],this.finalMap=[],this.walkers=[],this.tileCount=0,this.generated=!1;for(let t=0;t<this.mapDimensions.x;t++){this.map[t]=[];for(let e=0;e<this.mapDimensions.y;e++)this.map[t][e]=o.Empty}this.walkers.push(new m(new t(Math.floor(this.mapDimensions.x/2),Math.floor(this.mapDimensions.y/2)),e.getRandomDirection(),.55));let s=this.walkers[0];this.map[s.position.x][s.position.y]=o.Floor,this.visualise&&this.draw(this.ctx),this.tick()}tick(){if(this.tileCount/(this.mapDimensions.x*this.mapDimensions.y)>=this.fillPercentage){this.map=this.zoom(),this.map=this.zoom(),this.finalMap=[...this.map],this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.game.loadingStatus="Generating map (2/5) - Adding water";for(let t=0;t<this.mapDimensions.x;t++)for(let e=0;e<this.mapDimensions.y;e++)this.finalMap[t][e]=this.makeWater(this.map[t][e])?o.Water:this.map[t][e];this.game.loadingStatus="Generating map (3/5) - Removing too much water";for(let e=0;e<this.mapDimensions.x;e++)for(let s=0;s<this.mapDimensions.y;s++)if(this.checkSurroundingTiles(new t(e,s),[o.Water])>7&&Math.random()<.01)for(let t=-1;t<=1;t++)for(let i=-1;i<=1;i++)this.finalMap[e+t]&&this.finalMap[e+t][s+i]&&this.finalMap[e+t][s+i]==o.Water&&Math.random()<.3&&(this.finalMap[e+t][s+i]=o.Floor);this.map=this.zoom(),this.map=this.zoom(),this.finalMap=[...this.map],this.game.loadingStatus="Generating map (4/5) - Randomizing floor tiles";for(let t=0;t<this.mapDimensions.x;t++)for(let e=0;e<this.mapDimensions.y;e++)this.finalMap[t][e]=this.map[t][e]==o.Floor?this.createRandomFloorTile(this.floorConstraints):this.map[t][e];this.game.loadingStatus="Generating map (5/5) - Adding sand";for(let e=0;e<this.mapDimensions.x;e++)for(let s=0;s<this.mapDimensions.y;s++)this.finalMap[e][s]=this.makeSand(new t(e,s))?o.Sand:this.map[e][s];for(let e=0;e<this.mapDimensions.x;e++)for(let s=0;s<this.mapDimensions.y;s++)this.finalMap[e][s]=this.checkSand(new t(e,s))?this.createRandomFloorTile(this.floorConstraints):this.finalMap[e][s];return this.game.onlyMap?this.draw(this.ctx):(this.game.state=C.Running,this.game.ecs.addTrigger("render"),this.game.ecs.addTrigger("move")),this.generated=!0,this.game.loadingStatus="Finished generating map",void(this.game.mapDimensions=this.mapDimensions)}for(let t=0;t<this.walkers.length;t++){let e=this.walkers[t];this.map[e.position.x][e.position.y]==o.Empty&&(this.map[e.position.x][e.position.y]=o.Floor,this.tileCount++)}this.chanceToRemove(),this.changeDirection(),this.chanceToCreate(),this.updatePosition(),this.visualise&&this.draw(this.ctx),n(this.waitTime).then((()=>this.tick()))}draw(e,s=new t(0,0),i=this.map){e.clearRect(0,0,e.canvas.width,e.canvas.height),this.ctx.fillStyle="#000";for(let e=0;e<i.length;e++)for(let a=0;a<i.length;a++){let n,h;this.generated?i==this.map?(n=new t(Math.floor(this.tileSize.x*a)+s.x,Math.floor(this.tileSize.y*e)+s.y),h=new t(this.tileSize.x+1,this.tileSize.y+1)):(n=new t(Math.floor(this.game.canvas.width/i.length*a),Math.floor(this.game.canvas.height/i.length*e)),h=new t(this.game.canvas.width/i.length+1,this.game.canvas.height/i.length+1)):(n=new t(Math.floor(this.game.canvas.width/i.length*a),Math.floor(this.game.canvas.height/i.length*e)),h=new t(this.game.canvas.width/this.mapDimensions.x+1,this.game.canvas.height/this.mapDimensions.y+1));let l=i[e][a],m=!1;if(i==this.map&&[1,2,3,4].includes(l)&&(m=!0),!this.generated){if(m){this.game.draw(n,h,this.game.assets.images[1],new t(0,32),new t(32,32));continue}l==o.Sand?this.ctx.fillStyle="#c2a676":l==o.Water&&(this.ctx.fillStyle="#2a7fea"),this.ctx.fillRect(n.x,n.y,h.x,h.y)}if(n.x>-h.x&&n.x<this.game.canvas.width+h.x&&n.y>-h.y&&n.y<this.game.canvas.height+h.y&&this.generated){if(i==this.map){if(m){l==o.FloorEmpty?this.game.draw(n,h,this.game.assets.images[1],new t(0,32),new t(32,32)):l==o.FloorGrass?this.game.draw(n,h,this.game.assets.images[1],new t(0,0),new t(32,32)):l==o.FloorFlower?this.game.draw(n,h,this.game.assets.images[1],new t(32,0),new t(32,32)):this.ctx.fillStyle="#000";continue}if(l==o.Sand){this.game.draw(n,h,this.game.assets.images[1],new t(32,32),new t(32,32));continue}l==o.Water?this.ctx.fillStyle="#377":this.ctx.fillStyle="#000"}else l==r.Freezing?this.ctx.fillStyle="#fff":l==r.Cold?this.ctx.fillStyle="#cce":l==r.Temperate?this.ctx.fillStyle="#49a421":l==r.Warm&&(this.ctx.fillStyle="#edb021");this.game.draw(n,h)}}}updatePosition(){for(let t=0;t<this.walkers.length;t++){let e=this.walkers[t];e.position.x+=e.direction.x,e.position.y+=e.direction.y,e.position.x=e.position.x>this.mapDimensions.x-1?0:e.position.x<0?this.mapDimensions.x-1:e.position.x,e.position.y=e.position.y>this.mapDimensions.y-1?0:e.position.y<0?this.mapDimensions.y-1:e.position.y}}changeDirection(){for(let t=0;t<this.walkers.length;t++){let s=this.walkers[t];Math.random()<s.chanceToChange&&(s.direction=e.getRandomDirection())}}chanceToCreate(){for(let s=0;s<this.walkers.length;s++){let i=this.walkers[s];if(Math.random()<i.chanceToChange&&this.walkers.length<this.maxWalkers){let s=new t(i.position.x,i.position.y),a=e.getRandomDirection();this.walkers.push(new m(s,a,i.chanceToChange))}}}chanceToRemove(){for(let t=0;t<this.walkers.length;t++){let e=this.walkers[t];Math.random()<e.chanceToChange&&this.walkers.length>1&&this.walkers.splice(this.walkers.indexOf(e),1)}}removeTooMuchWater(t){if(this.map[t.x][t.y]==o.Water&&this.checkSurroundingTiles(t,[o.Water])>5&&Math.random()<.01)return!0}checkSurroundingTiles(t,e,s=-1,i=2,a=this.map){let n=0;for(let o=s;o<i;o++)for(let h=s;h<i;h++)null==a[t.x+o]||null==a[t.x+o][t.y+h]||0==o&&0==h||e.includes(a[t.x+o][t.y+h])&&n++;return n}checkAdjacentTiles(t,s,i=this.map){let a=0;for(let n=0;n<4;n++)null!=i[t.x+e.cardinalDirections[n].x]&&null!=i[t.x+e.cardinalDirections[n].x][t.y+e.cardinalDirections[n].y]&&s.includes(i[t.x+e.cardinalDirections[n].x][t.y+e.cardinalDirections[n].y])&&a++;return a}makeSand(t){if([o.Empty,o.Water].includes(this.map[t.x][t.y])&&this.checkSurroundingTiles(t,[o.Floor,o.FloorEmpty,o.FloorFlower,o.FloorGrass],-2,3))return!0}checkSand(t){if(this.map[t.x][t.y]==o.Sand&&this.checkAdjacentTiles(t,[o.Floor,o.FloorEmpty,o.FloorFlower,o.FloorGrass])>2)return!0}makeWater(t){if(t==o.Empty)return!0}createRandomFloorTile(t){let e=Math.random();return e<t.x?o.FloorFlower:e<t.y?o.FloorGrass:o.FloorEmpty}zoom(e=this.map){let s=[...e];s=s.map((t=>t.map((t=>[t,t])).flat(1))).map((t=>[[...t],[...t]])).flat(1);for(let e=0;e<s.length;e++)for(let i=0;i<s[e].length;i++)if(s[e][i]==o.Floor){this.checkSurroundingTiles(new t(e,i),[o.Floor],-1,2,s)>4&&Math.random()<.07&&(s[e][i]=o.Empty)}else{this.checkSurroundingTiles(new t(e,i),[o.Floor],-2,3,s)>1&&Math.random()<.14&&(s[e][i]=o.Floor)}return e==this.map&&(this.mapDimensions.x*=2,this.mapDimensions.y*=2),s}}class p{constructor(t,e,s){this.requiredComponents=t,this.trigger=e,this.func=s}}class d{constructor(){this.entities=[],this.systemManager=new g}addEntity(t,e){this.entities.push(t),null!=e&&(t.components=e)}addSystem(t){this.systemManager.systems.push(t)}addTrigger(t){this.systemManager.triggers.includes(t)||this.systemManager.addTrigger(t)}update(t,e){this.systemManager.updateSystems(this.entities,t,e)}}class g{constructor(){this.systems=[],this.triggers=[]}addSystem(t){this.systems.push(t)}addTrigger(t){this.triggers.push(t)}removeTrigger(t){this.triggers.splice(this.triggers.indexOf(t),1)}updateSystems(t,e,s){for(let i=0;i<this.systems.length;i++){const a=this.systems[i];if(this.triggers.includes(a.trigger))for(let i=0;i<t.length;i++){const n=t[i];let o=0;for(let t=0;t<n.components.length;t++)for(let e=0;e<a.requiredComponents.length;e++)Object.getPrototypeOf(n.components[t]).constructor==a.requiredComponents[e]&&o++;o==a.requiredComponents.length&&a.func(n,e,s)}}}}class u{constructor(t){this.id=t,this.components=[]}getComponent(t){for(let e of this.components)if(e.name==t)return e}setComponent(t){for(let e=0;e<this.components.length;e++)this.components[e].name==t.name&&(this.components[e]=t)}}class f{constructor(t){this.name=t}}class w extends f{constructor(){super("move")}}class y extends f{constructor(t,e,s){super("image"),this.image=t,this.srcPos=e,this.srcDim=s}}class x extends f{constructor(t){super("position"),this.position=t}}class v extends f{constructor(t){super("dimensions"),this.dimensions=t}}class S extends p{constructor(){super([y,x,v],"render",((t,e)=>{const s=t.getComponent("image").image,i=t.getComponent("image").srcPos,a=t.getComponent("image").srcDim,n=t.getComponent("position").position,o=t.getComponent("dimensions").dimensions;e.drawImage(s,i.x,i.y,a.x,a.y,n.x,n.y,o.x,o.y)}))}}class M extends p{speed=2;foot=1;frame=new t(0,0);constructor(){super([w],"move",((e,s,i)=>{this.moveX=0,this.moveY=0;let a=Array(4).fill(!1);(k.w||k.ArrowUp)&&(a[0]=!0,k.a||k.ArrowLeft||k.d||k.ArrowRight?this.moveY+=Math.sin(45)*this.speed:this.moveY+=this.speed),(k.s||k.ArrowDown)&&(a[2]=!0,k.a||k.ArrowLeft||k.d||k.ArrowRight?this.moveY-=Math.sin(45)*this.speed:this.moveY-=this.speed),(k.a||k.ArrowLeft)&&(a[1]=!0,k.w||k.ArrowUp||k.s||k.ArrowDown?this.moveX+=Math.sin(45)*this.speed:this.moveX+=this.speed),(k.d||k.ArrowRight)&&(a[3]=!0,k.w||k.ArrowUp||k.s||k.ArrowDown?this.moveX-=Math.sin(45)*this.speed:this.moveX-=this.speed),i.mapOffset.x>=0&&(i.mapOffset.x=0,this.moveX=this.moveX>0?0:this.moveX),i.mapOffset.x<=-Math.floor(i.mapDimensions.x*i.map.tileSize.x-i.canvas.width)&&(i.mapOffset.x=-Math.floor(i.mapDimensions.x*i.map.tileSize.x-i.canvas.width),this.moveX=this.moveX<0?0:this.moveX),i.mapOffset.y>=0&&(i.mapOffset.y=0,this.moveY=this.moveY>0?0:this.moveY),i.mapOffset.y<=-Math.floor(i.mapDimensions.y*i.map.tileSize.y-i.canvas.height)&&(i.mapOffset.y=-Math.floor(i.mapDimensions.y*i.map.tileSize.y-i.canvas.height),this.moveY=this.moveY<0?0:this.moveY);for(let t=0;t<4;t++)a[t]&&a[(t+2)%4]&&(a[t]=!1,a[(t+2)%4]=!1),0==t?a[t]&&(a[t+1]||a[t+3])&&(a[t+1]=!1,a[t+3]=!1):2==t&&a[t]&&(a[t-1]||a[t+1])&&(a[t-1]=!1,a[t+1]=!1);let n=a.indexOf(!0);if(a.every((t=>!1===t)))this.frame.x=0;else if(this.frame.y=n,i.frames%12==0)switch(n){case 0:case 2:0==this.frame.x?this.frame.x=this.foot:(1==this.foot?this.foot=2:this.foot=1,this.frame.x=0);break;case 1:case 3:0==this.frame.x?this.frame.x=1:this.frame.x=0}i.ecs.entities[0].setComponent(new y(i.assets.images[0],t.multiply(this.frame,null,32),new t(32))),i.mapOffset=t.add(i.mapOffset,new t(this.moveX,this.moveY))}))}}const k=[];let D;var b;document.addEventListener("keydown",(t=>{k[t.key]=!0})),document.addEventListener("keyup",(t=>{k[t.key]=!1})),(b=D||(D={}))[b.image=0]="image",b[b.audio=1]="audio";var F;F=JSON.parse('{"name":"the_adventures_of_stewin","author":"Maxwell Robati","version":"0.1.1","license":"MIT","source":"src/main.ts","targets":{"bundle":{"sourceMap":false,"optimize":true,"outputFormat":"commonjs","distDir":"build"}},"scripts":{"watch":"parcel watch","build":"parcel build --no-cache"},"dependencies":{"parcel":"latest","simplex-noise":"^4.0.1"}}');const T=document.querySelector.bind(document);let C;var A;(A=C||(C={}))[A.Loading=0]="Loading",A[A.Running=1]="Running",A[A.Paused=2]="Paused",A[A.Menu=3]="Menu",A[A.Settings=4]="Settings",A[A.Info=5]="Info";class E{frames=0;stop=!1;constructor(e,s,i=!1,a=i){this.dimensions=e,this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=this.dimensions.x,this.canvas.height=this.dimensions.y,this.playerSize=new t(this.canvas.width/10),this.assets=s,this.state=C.Menu,this.loadingStatus="",this.ctx.imageSmoothingEnabled=!1,this.visualiseMap=i,this.onlyMap=a}init(){this.frames=0,this.stop=!0,this.tick(),this.stop=!1,this.mapDimensions=new t(16),this.initECS().then((()=>this.generateMap().then((()=>{this.mapOffset=new t(this.canvas.width/2-this.map.tileSize.x*this.mapDimensions.x/2),this.assets.audio[0].loop=!0,this.assets.audio[0].play()}))))}initECS(){return new Promise((e=>{this.ecs=new d,this.loadingStatus="Loading player",this.ecs.addEntity(new u(this.ecs.entities.length),[new y(this.assets.images[0],new t(0,64),new t(32,32)),new x(new t(this.canvas.width/2-this.playerSize.x/2,this.canvas.height/2-this.playerSize.y/2)),new v(this.playerSize),new w]),this.ecs.addSystem(new S),this.ecs.addSystem(new M),e("resolved")}))}generateMap(){return new Promise((e=>{if(null!=this.map&&!this.map.generated)return void console.warn("Map is already generating");this.map=new c(this.mapDimensions,this.ctx,100,.4,this.visualiseMap,0,this,new t(this.playerSize.x/1.5,this.playerSize.y/1.5)),this.map.initMap();let s=setInterval((()=>{this.map.generated&&(e("resolved"),clearInterval(s))}))}))}draw(t,e,s,i,a){null==s?this.ctx.fillRect(t.x,t.y,e.x,e.y):this.ctx.drawImage(s,i.x,i.y,a.x,a.y,t.x,t.y,e.x,e.y)}tick(){if(this.state===C.Running){if(!this.map.generated)return;this.frames++,this.map.draw(this.ctx,this.mapOffset),this.ecs.update(this.ctx,this)}this.state===C.Loading&&!1===this.visualiseMap&&this.loading(),this.state===C.Menu&&this.menu(),this.state===C.Info&&this.info(),this.state===C.Settings&&this.settings(),this.stop||n(1e3/60).then((()=>{this.tick()}))}loading(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.font="30px Roboto Mono",this.ctx.fillStyle="#cbb",this.ctx.fillText(`${this.loadingStatus}...`,25,50)}menu(){if(this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.globalAlpha=.55,this.draw(new t(0),this.dimensions,this.assets.images[2],new t(0),new t(256)),this.ctx.globalAlpha=1,null==document.querySelector("div")){const t=s("span","start","button","Start Game!"),e=s("span","info","button","Info");document.body.appendChild(s("div","menu","menu")),a("menu",[t,e]),T("#start").addEventListener("click",(()=>{this.state=C.Loading,i("menu"),this.init()})),T("#info").addEventListener("click",(()=>{this.state=C.Info,i("menu")}))}}info(){if(this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.globalAlpha=.55,this.draw(new t(0),this.dimensions,this.assets.images[2],new t(0),new t(256)),this.ctx.globalAlpha=1,null==document.querySelector("div")){const t=s("span","back","button","Back"),e=s("span","info","text","Info");e.innerHTML="This is a game about a guy who walks around and does stuff.<br><br>It's pretty great you should donate to my patreon <br><a>here</a>",document.body.appendChild(s("div","info","info")),a("info",[t,e]),T("#back").addEventListener("click",(()=>{this.state=C.Menu,i("info")}))}}settings(){if(this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.globalAlpha=.55,this.draw(new t(0),this.dimensions,this.assets.images[2],new t(0),new t(256)),this.ctx.globalAlpha=1,null==document.querySelector("div")){const t=s("span","back","button","Back"),e=s("span","settings","text","Settings"),n=s("span","mapSettings","text","Map Settings");e.innerHTML="This is where you can change settings and stuff",n.innerHTML="<br><input type='checkbox' id='visMap'></input>",document.body.appendChild(s("div","settings","settings")),a("settings",[t,e,n]),T("#back").addEventListener("click",(()=>{this.state=C.Menu,i("settings")}))}}}const R=new class{#t;constructor(t){this.#t=t}loadAsset(t){return new Promise(((e,s)=>{if(t.type===D.image){const i=new Image;i.src=t.path,i.onload=t=>e(i),i.onerror=s}else if(t.type===D.audio){const i=new Audio;i.src=t.path,i.oncanplaythrough=t=>e(i),i.onerror=s}}))}async loadAssets(){const t=await Promise.all(this.#t.map((t=>this.loadAsset(t))));let e=[],s=[];return t.forEach((t=>{"IMG"==t.tagName?e.push(t):"AUDIO"==t.tagName&&s.push(t)})),{images:e,audio:s}}}([{type:D.image,path:"resources/images/StewieSpriteSheet.png"},{type:D.image,path:"resources/images/TileSheet.png"},{type:D.image,path:"resources/images/Placeholder.png"},{type:D.audio,path:"resources/audio/TitleLong.wav"}]);let z,W,L;(async()=>{let e="color: #cbb; font-size: 15px; font-family: 'Roboto Mono', monospace; font-weight: bold; text-shadow: 0 0 10px #cbb;";console.log("%cVersion: "+F.version+"\nMade by: "+F.author,e),console.log("%cCheck out the project repo: "+location.href.split("/").slice(0,-1).join("/")+"/github.html",e),z=await R.loadAssets(),W=new t(innerHeight/6*5),L=new E(W,z),L.tick()})(),addEventListener("click",(t=>{"A"==t.target.tagName&&window.open("https://www.youtube.com/watch?v=dQw4w9WgXcQ")}));